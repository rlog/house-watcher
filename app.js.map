{"version":3,"sources":["app.es6.js"],"names":[],"mappings":"AA+Be;;;iCAEf,aAA6B;AACzB;AACA,YAAI,iBAAiB,IAArB;;AAEA,YAAI,CAAC,WAAW,MAAhB,EAAwB;AACpB,mBAAO,KAAP,CAAa,wBAAb;AACA;AACH;;AAED,YAAI;AACA;AACA,6BAAiB,MAAM,WAAW,GAAX,CAAe,UAAf,EAA2B,OAA3B,CAAmC,OAAnC,CAAvB;AACH,SAHD,CAGE,OAAO,GAAP,EAAY;AACV,mBAAO,KAAP,CAAa,GAAb;;AAEA,gBAAI,KAAJ,EAAW;AACP,2BAAW,WAAX,EAAwB,IAAxB;AACA;AACH,aAHD,MAGO;AACH,uBAAO,IAAP,CAAY,WAAZ;AACA,wBAAQ,YAAR,EAAuB,UAAQ,KAAM,SAArC;AACA;AACH;AACJ;;AAED;AACA,YAAI,YAAY,QAAQ,IAAR,CAAa,eAAe,IAA5B,CAAhB;;AAEA;AACA,YAAI,aAAa,UAAU,GAAV,EAAe,MAAf,CAAjB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,mBAAW,IAAX,CAAgB,UAAC,GAAD,EAAM,IAAN,EAAe;AAC3B,gBAAI,QAAQ,UAAU,IAAV,EAAgB,IAAhB,EAAZ;AACA,gBAAI,OAAQ,UAAU,IAAV,EAAgB,IAAhB,CAAqB,MAArB,CAAZ;AACA,uBAAW,GAAX,CAAe,UAAC,IAAD,EAAO,GAAP,EAAe;AAC1B,oBAAI,MAAM,OAAN,CAAc,IAAd,MAAwB,CAAC,CAA7B,EAAgC;AAC5B,4BAAS,SAAT,EAAoB,MAAI,KAAM,QAAK,IAAK,KAAE,IAAK,GAA/C;AACH;AACJ,aAJD;AAKH,SARD;AASH,K;;oBAjDc,W;;;;;;;AAjCf,MAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,MAAM,aAAa,QAAQ,YAAR,CAAnB;AACA,MAAM,SAAS,QAAQ,QAAR,CAAf;;AAEA,OAAO,SAAP,CAAiB;AACb,eAAW,CAAC;AACR,cAAM;AADE,KAAD,EAER;AACC,cAAM,MADP;AAEC,kBAAU,YAFX;AAGC,oBAAY,OAAK,GAHlB;AAIC,iBAAS;AAJV,KAFQ,CADE;AASb,oBAAgB;AATH,CAAjB;;AAYA,SAAS,OAAO,SAAP,CAAiB,QAAjB,CAAT;;AAEA,IAAI,OAAO,QAAQ,IAAnB;AACA,KAAK,KAAL;AACA,KAAK,KAAL;;AAEA,MAAM,aAAa,IAAnB;AACA,OAAO,IAAP,CAAY,UAAZ;AACA;AACA,MAAM,UAAU,KAAhB;AACA,MAAM,OAAO,wBAAb;AACA;AACA,MAAM,aAAa,OAAO,4DAA1B;AACA,MAAM,SAAS,mCAAf;;AAEA,IAAI,QAAQ,CAAZ;;AAqDA,SAAS,OAAT,CAAiB,KAAjB,EAAwB,OAAxB,EAAiC;AAC7B,QAAI,MAAM,QAAQ,aAAR,EAAuB,GAAjC;AACA,QAAI,MAAO,uBAAqB,GAAI,QAApC;AACA,YAAQ,GAAR,CAAY,GAAZ;AACA,eACK,GADL,CACS,GADT,EAEK,KAFL,CAEW,EAAE,MAAM,KAAR,EAAe,MAAM,OAArB,EAFX,EAGK,GAHL,CAGS,CAAC,GAAD,EAAM,GAAN,KAAc;AACf,YAAI,OAAO,KAAK,KAAL,CAAW,IAAI,IAAf,CAAX;;AAEA,YAAI,GAAJ,EAAS;AACL,mBAAO,KAAP,CAAc,WAAS,GAAI,GAA3B;AACH,SAFD,MAEO,IAAI,KAAK,KAAT,EAAgB;AACnB,mBAAO,KAAP,CAAc,WAAS,KAAK,MAAO,GAAnC;AACH,SAFM,MAEA;AACH,mBAAO,IAAP,CAAa,YAAU,OAAQ,GAA/B;AACH;AACJ,KAbL;AAcH;;AAED,QAAQ,KAAR,EAAe,QAAf;AACA","file":"app.js","sourcesContent":["const cheerio = require('cheerio');\nconst superagent = require('superagent');\nconst log4js = require('log4js');\n\nlog4js.configure({\n    appenders: [{\n        type: 'console'\n    }, {\n        type: 'file',\n        filename: 'access.log',\n        maxLogSize: 1024*100,\n        backups: 4\n    }],\n    replaceConsole: true\n});\n\nlogger = log4js.getLogger('normal');\n\nlet argv = process.argv;\nargv.shift();\nargv.shift();\n\nconst watchNames = argv;\nlogger.info(watchNames);\n// const watchNames = ['富兴鹏城', '金隅汇景苑（20号楼）'];\nconst TIMEOUT = 20000;\nconst HOST = 'http://www.bjjs.gov.cn';\n// const beginPage = HOST + '/tabid/1072/MoreModuleID/10416/MoreTabID/4021/Default.aspx';\nconst resultPage = HOST + '/tabid/1072/MoreModuleID/10417/MoreTabID/4021/Default.aspx';\nconst listId = '#ess_ctr9680_ListC_Info_LstC_Info';\n\nlet retry = 5; // 重试次数\n\nasync function fetchReslut() {\n    // let beginPageHtml = null;\n    let resultPageHtml = null;\n\n    if (!watchNames.length) {\n        logger.error('参数丢失，请在命令后面跟上需要关注的楼盘名称');\n        return;\n    }\n\n    try {\n        // beginPageHtml = await superagent.get(beginPage).timeout(TIMEOUT);\n        resultPageHtml = await superagent.get(resultPage).timeout(TIMEOUT);\n    } catch (err) {\n        logger.error(err);\n\n        if (retry) {\n            setTimeout(fetchReslut, 3000);\n            retry--;\n        } else {\n            logger.info('访问住建委网站失败');\n            msgSend('访问住建委网站失败！', `服务器君试了${retry}次都没有成功`);\n            return;\n        }\n    }\n\n    // let beginDom = cheerio.load(beginPageHtml.text);\n    let resultDom = cheerio.load(resultPageHtml.text);\n\n    // let beginList = beginDom('a', listId);\n    let resultList = resultDom('a', listId);\n\n    // beginList.each((idx, item) => {\n    //     let title = beginDom(item).text();\n    //     watchNames.map((name, idx) => {\n    //         if (title.indexOf(name) !== -1) {\n    //             console.log(`${title} 已经开始摇号了`);\n    //         }\n    //     });\n    // });\n\n    resultList.each((idx, item) => {\n        let title = resultDom(item).text();\n        let link  = resultDom(item).attr('href');\n        watchNames.map((name, idx) => {\n            if (title.indexOf(name) !== -1) {\n                msgSend(`摇号结果出来了`, `**${title}** ${HOST}${link}`);\n            }\n        });\n    });\n}\n\nfunction msgSend(title, content) {\n    let key = require('./config.js').key;\n    let uri = `http://sc.ftqq.com/${key}.send`;\n    console.log(uri);\n    superagent\n        .get(uri)\n        .query({ text: title, desp: content })\n        .end((err, res) => {\n            let data = JSON.parse(res.text);\n\n            if (err) {\n                logger.error(`消息推送失败：${err}`);\n            } else if (data.errno) {\n                logger.error(`消息推送失败：${data.errmsg}`);\n            } else {\n                logger.info(`推送消息成功: ${content}`);\n            }\n        });\n}\n\nmsgSend('哇哈哈', 'bababa');\n// fetchReslut();"]}